{% extends 'base.html' %}
{% load static %}
{% block title %}Operator Form{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'jal/css/upper.css' %}">
<div class="upper">
    <div class="top-row">
        <div class="img">
            <img src="{% static 'jal/images/full_logo.png' %}" alt="Logo">
        </div>
        <div class="page-title">
            <h2 style='color: #1175B7;'>Operator Form</h2>
        </div>
        <div class="account-dropdown">
    <button><img src="{% static 'jal/images/icon.png' %}" alt="Account Icon"></button>
    <div class="account-dropdown-content">
        <a href="{% url 'accountdetails' %}">My Profile</a>
        <a href="{% url 'changepassword' %}">Change Password</a>
        <a href="{% url 'Log_out' %}">Logout</a>
    </div>
</div>
    </div>
</div>

<hr>

        <div class="form-wrapper operator-form">
    <form method="POST" action="">{% csrf_token %}
        <div class="form-grid operator-grid">
            <!-- Fields for Operator Form -->
            <div><label>Employee ID:</label></div>
            <div>{{ next_id }}</div>

            <div><label for="roleid">Role ID:</label></div>
            <div><input type="text" id="roleid" name="roleid" class="uniform-input" required></div>

            <div><label for="emailid">Email-ID:</label></div>
            <div><input type="text" id="emailid" name="emailid" class="uniform-input" required></div>

            <div><label for="usern">Username:</label></div>
            <div><input type="text" id="usern" name="usern" class="uniform-input" required></div>

            <div><label for="password">Password:</label></div>
            <div><input type="password" id="password" name="password" class="uniform-input" required></div>

            <div><label for="firstn">First Name:</label></div>
            <div><input type="text" id="firstn" name="firstn" class="uniform-input" required></div>

            <div><label for="lastn">Last Name:</label></div>
            <div><input type="text" id="lastn" name="lastn" class="uniform-input" required></div>

            <div><label for="gender">Gender:</label></div>
            <div>
                <select name="gender" id="gender" class="uniform-dropdown" required>
                    <option disabled selected>Select a gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>

            <div><label for="mobno">Mobile Number:</label></div>
            <div><input type="tel" id="mobno" name="mobno" class="uniform-input" required></div>

            <div><label for="location">Location:</label></div>
            <div>
                <select id="location" name="location" class="uniform-dropdown" required>
                    <option value="" disabled selected>Select Location</option>
                    {% for loc in locations %}
                        <option value="{{ loc.location_id }}">{{ loc.location_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div><label for="sub_location">Sub Location:</label></div>
            <div>
                <div class="custom-dropdown" id="customDropdown">
                    <button type="button" id="dropdownButton">Select Sub Locations</button>
                    <div id="checkboxContainer" class="dropdown-content"></div>
                </div>
            </div>
        </div>

        <div id="selectedSubInputs"></div>
        <button type="submit">Save</button>
    </form>
</div>

<hr>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const allSubLocations = [
        {% for sub in sub_locations %}
        { id: "{{ sub.sub_location_id }}", name: "{{ sub.sub_location_name }}", location_id: "{{ sub.location_id }}" },
        {% endfor %}
    ];

    const locationSelect = document.getElementById('location');
    const checkboxContainer = document.getElementById('checkboxContainer');
    const selectedSubInputs = document.getElementById('selectedSubInputs');
    const dropdown = document.getElementById('customDropdown');

    document.getElementById('dropdownButton').addEventListener('click', function () {
        dropdown.classList.toggle('show'); // This toggles the visibility of the dropdown
    });

    document.addEventListener('click', function (e) {
        if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('show'); // Hide the dropdown if clicked outside
        }
    });

    locationSelect.addEventListener('change', function () {
        const selectedLocationId = this.value;
        checkboxContainer.innerHTML = '';
        selectedSubInputs.innerHTML = '';

        const filtered = allSubLocations.filter(sub => sub.location_id === selectedLocationId);
        if (filtered.length === 0) {
            checkboxContainer.innerHTML = '<p style="padding: 5px;">No sub-locations available</p>';
            return;
        }

        filtered.forEach(sub => {
            const wrapper = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'sub_location[]';
            checkbox.value = sub.id;
            checkbox.addEventListener('change', updateHiddenInputs);
            wrapper.appendChild(checkbox);
            wrapper.append(' ' + sub.name);
            checkboxContainer.appendChild(wrapper);
        });
    });

    function updateHiddenInputs() {
        selectedSubInputs.innerHTML = '';
        const selected = checkboxContainer.querySelectorAll('input[type="checkbox"]:checked');
        selected.forEach(cb => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'sub_location[]';
            hidden.value = cb.value;
            selectedSubInputs.appendChild(hidden);
        });
    }
});
</script>
{% endblock %}
